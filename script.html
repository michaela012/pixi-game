<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }

    PIXI.utils.sayHello(type)

  //Aliases
  let Loader = PIXI.Loader;
  let Sprite = PIXI.Sprite;


  //Create a Pixi Application
  let app = new PIXI.Application({ 
      width: 500, 
      height: 400,                       
      antialias: true, 
      transparent: false, 
      resolution: 1
    }
  );
  //Add the canvas that Pixi automatically created for you to the HTML document
  document.body.appendChild(app.view);

  //load spritesheets and run `setup` function
  Loader.shared
    .add("Spritesheets/playerSprites.json")
    .load(setup);

  //define vars
  let p1, state, playerSprites, p1WalkTextures;

  //handle keyboard input
  function keyboard(value){
    let key = {};
    key.value = value;
    key.isDown = false;
    key.isUp = true;
    key.press = undefined;
    key.release = undefined;

    //The `downHandler`
    key.downHandler = event => {
      if (event.key === key.value) {
        if (key.isUp && key.press) key.press();
        key.isDown = true;
        key.isUp = false;
        event.preventDefault();
      }
    };

    //The `upHandler`
    key.upHandler = event => {
      if (event.key === key.value) {
        if (key.isDown && key.release) key.release();
        key.isDown = false;
        key.isUp = true;
        event.preventDefault();
      }
    };

    //Attach event listeners
    const downListener = key.downHandler.bind(key);
    const upListener = key.upHandler.bind(key);
    
    window.addEventListener(
      "keydown", downListener, false
    );
    window.addEventListener(
      "keyup", upListener, false
    );
    
    // Detach event listeners
    key.unsubscribe = () => {
      window.removeEventListener("keydown", downListener);
      window.removeEventListener("keyup", upListener);
    };
    
    return key;
  }


  //This `setup` function will run when the image has loaded
  function setup() {
    //load spritesheets
    //playerSprites = Loader.shared.resources["Spritesheets/playerSprites.json"].spritesheet.textures;
    let p1WalkTextures = [];
    let p2WalkTextures = [];

    let animations = {
      "p1_walk": ["p1_walk01.png","p1_walk02.png","p1_walk03.png","p1_walk04.png","p1_walk05.png","p1_walk06.png","p1_walk07.png","p1_walk08.png","p1_walk09.png","p1_walk10.png","p1_walk11.png"],
      "p2_walk": ["p2_walk01.png","p2_walk02.png","p2_walk03.png","p2_walk04.png","p2_walk05.png","p2_walk06.png","p2_walk07.png","p2_walk08.png","p2_walk09.png","p2_walk10.png","p2_walk11.png"]
    };

    for (i=0; i <= 10; i++){
      p1WalkTextures[i] = PIXI.Texture.from(animations.p1_walk[i]);
      p2WalkTextures[i] = PIXI.Texture.from(animations.p2_walk[i]);
    }

    let p1Textures= {"walkTextures" : p1WalkTextures, 
      "duck": PIXI.Texture.from("p1_duck.png"), 
      "front": PIXI.Texture.from("p1_front.png"), 
      "hurt": PIXI.Texture.from("p1_hurt.png"), 
      "jump": PIXI.Texture.from("p1_jump.png"), 
      "stand": PIXI.Texture.from("p1_stand.png")};

    let p2Textures= {"walkTextures" : p2WalkTextures, 
      "duck": PIXI.Texture.from("p2_duck.png"), 
      "front": PIXI.Texture.from("p2_front.png"), 
      "hurt": PIXI.Texture.from("p2_hurt.png"), 
      "jump": PIXI.Texture.from("p2_jump.png"), 
      "stand": PIXI.Texture.from("p2_stand.png")};
    


    //vars
    let spriteScale = 40;
    let spriteScaleHeight = spriteScale + (spriteScale*.2);

    //make sprites
    p1 = new Sprite(p1Textures.front);
    p1.height = spriteScaleHeight;
    p1.width = spriteScale;
    p1.y = app.screen.height / 2 - p1.height/2;
    p1.x=100;
    p1.vx = 0;
    p1.vy = 0;

    //Add elements to stage
    app.stage.addChild(p1);
    

    //listen for keyboard input
    let left = keyboard("ArrowLeft"),
      right = keyboard("ArrowRight"),
      up = keyboard("ArrowUp"),
      down = keyboard("ArrowDown");
    
    //key press and release methods
    // left
    left.press = () => {
      p1.vx = -1;
      p1.texture = p1Textures.walkTextures[0];
      p1.texture.rotate = 12;
    }
    left.release = () => {
      p1.vx = 0;
      p1.texture = p1Textures.stand;
      p1.texture.rotate = 12;
    }

    //right
    right.press = () => {
      p1.vx = 1;
      p1.texture = p1WalkTextures[0];
      p1.texture.rotate = 0;
    }
    right.release = () => {
      p1.vx = 0;
      p1.texture = p1Textures.stand;
      p1.texture.rotate = 0;
    }

    //up
    up.press = () => {
      p1.vy = -1;
      p1.texture = p1Textures.jump;
    }
    up.release = () => {
      p1.vy = 0;
      p1.texture = p1Textures.stand;
    }

    //down
    down.press = () => {
      p1.vy = 1;
      p1.height = spriteScale;
      p1.texture = p1Textures.duck;
    }
    down.release = () => {
      p1.vy = 0;
      p1.height = spriteScaleHeight;
      p1.texture = p1WalkTextures[1];

    }



    //set game state
    state = play;
    //start game loop
    app.ticker.add(delta => gameLoop(delta));
  }

  function gameLoop(delta) {
    state(delta);
  }

  function play(delta){
    //Move player
    p1.x += p1.vx;
    p1.y += p1.vy;

  }

  


  </script>
</body>
</html>
